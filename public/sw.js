"use strict";(()=>{var c="rico-ouro-cache-v21",p=["/","/manifest.json","/offline.html","/logo.svg","/icon-192.png","/icon-512.png","/icon-maskable-192.png","/icon-maskable-512.png","/apple-touch-icon.png","/splash.png","/login","/home","/bois","/matrizes","/cadastro","/consulta","/reproducao","/vacinas","/nascimentos","/pesagem-ce","/importar","/importar/planilhas","/gerenciar","/gerenciar/fazendas","/gerenciar/classe","/gerenciar/status","/geral","/geral/bois","/geral/relatorios","/geral/relatorios/pdf","/geral/relatorios/planilhas"];async function m(e){let a=await caches.open(c);for(let r of e)try{if(!await a.match(r)){let n=await fetch(r);n&&n.status===200&&(await a.put(r,n),console.log(`Service Worker: Proactively cached ${r}`))}}catch(t){console.warn(`Service Worker: Failed to proactively cache ${r}`,t)}}self.addEventListener("install",e=>{console.log("Service Worker: Installing..."),e.waitUntil(caches.open(c).then(async a=>{console.log("Service Worker: Caching App Shell");let r=p.map(async t=>{try{await a.add(t),console.log(`Service Worker: Cached ${t}`)}catch(n){console.warn(`Service Worker: Failed to cache ${t}`,n)}});await Promise.all(r)})),self.skipWaiting()});self.addEventListener("activate",e=>{console.log("Service Worker: Activating..."),e.waitUntil(caches.keys().then(a=>Promise.all(a.map(r=>{if(r!==c)return console.log("Service Worker: Removing old cache",r),caches.delete(r)})))),self.clients.claim()});self.addEventListener("message",e=>{if(e.data&&e.data.type==="CACHE_DYNAMIC_ROUTES"){let a=e.data.urls;console.log(`Service Worker: Received request to cache ${a.length} dynamic routes`),e.waitUntil(m(a))}e.data&&e.data.type==="SKIP_WAITING"&&self.skipWaiting()});self.addEventListener("fetch",e=>{if(e.request.method!=="GET"||e.request.url.startsWith("chrome-extension"))return;let a=new URL(e.request.url);if(a.pathname.startsWith("/_next/static/")){e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(t=>{if(t&&t.status===200){let n=t.clone();caches.open(c).then(o=>{o.put(e.request,n)})}return t})));return}if(e.request.mode==="navigate"||e.request.headers.get("accept")?.includes("text/html")||a.pathname.includes("/_next/data/")){e.respondWith(fetch(e.request).then(r=>{if(r&&r.status===200){let t=r.clone();caches.open(c).then(n=>{n.put(e.request,t)})}return r}).catch(async()=>{let r=await caches.match(e.request);if(r)return r;if(e.request.mode==="navigate"){let n=await caches.match("/");if(n)return n}let t=await caches.match("/offline.html");return t||new Response(`<!DOCTYPE html>
            <html lang="pt-BR">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Offline - INDI Ouro</title>
              <style>
                body { font-family: system-ui, sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; background: #1162ae; color: white; text-align: center; padding: 20px; }
                a { display: inline-block; margin-top: 20px; padding: 12px 24px; background: white; color: #1162ae; text-decoration: none; border-radius: 8px; font-weight: 600; }
              </style>
            </head>
            <body>
              <div>
                <h1>\u{1F4F4} Offline</h1>
                <p>P\xE1gina n\xE3o dispon\xEDvel offline no momento.</p>
                <a href="/home">Ir para In\xEDcio</a>
              </div>
            </body>
            </html>`,{status:503,statusText:"Service Unavailable",headers:new Headers({"Content-Type":"text/html; charset=utf-8"})})}));return}if(a.pathname.endsWith(".js")){e.respondWith(fetch(e.request).then(r=>{if(r&&r.status===200&&r.type==="basic"){let t=r.clone();caches.open(c).then(n=>{n.put(e.request,t)})}return r}).catch(()=>caches.match(e.request).then(r=>r||new Response("Offline",{status:503}))));return}e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(t=>{if(!t||t.status!==200||t.type!=="basic")return t;let n=t.clone();return caches.open(c).then(o=>{o.put(e.request,n)}),t}).catch(()=>new Response("Offline",{status:503}))))});var y="offline-sync-queue",s="requests",S=5;async function d(){return new Promise((e,a)=>{let r=indexedDB.open(y,1);r.onupgradeneeded=t=>{let n=t.target.result;n.objectStoreNames.contains(s)||n.createObjectStore(s,{keyPath:"id"})},r.onsuccess=t=>{e(t.target.result)},r.onerror=()=>{a(new Error("Failed to open sync database"))}})}async function w(){try{let r=(await d()).transaction(s,"readonly").objectStore(s);return new Promise((t,n)=>{let o=r.getAll();o.onsuccess=()=>t(o.result||[]),o.onerror=()=>n(new Error("Failed to get pending requests"))})}catch(e){return console.warn("Service Worker: Could not access sync queue",e),[]}}async function l(e){try{let t=(await d()).transaction(s,"readwrite").objectStore(s);return new Promise((n,o)=>{let i=t.delete(e);i.onsuccess=()=>n(),i.onerror=()=>o(new Error(`Failed to remove ${e}`))})}catch(a){console.warn("Service Worker: Could not remove from queue",a)}}async function g(e){try{let t=(await d()).transaction(s,"readwrite").objectStore(s),n={...e,retries:e.retries+1};return new Promise((o,i)=>{let f=t.put(n);f.onsuccess=()=>o(),f.onerror=()=>i(new Error(`Failed to update ${e.id}`))})}catch(a){console.warn("Service Worker: Could not update retry count",a)}}async function u(e){(await self.clients.matchAll({type:"window"})).forEach(r=>{r.postMessage(e)})}self.addEventListener("sync",e=>{console.log("Service Worker: Sync event fired",e.tag),e.tag==="sync-data"&&e.waitUntil(h())});async function h(){console.log("Service Worker: Executing background sync...");let e=await w();if(e.length===0){console.log("Service Worker: No pending requests to sync"),u({type:"SYNC_COMPLETE",data:{synced:0}});return}console.log(`Service Worker: Found ${e.length} pending requests`),u({type:"SYNC_STARTED",data:{pending:e.length}});let a=0,r=0;for(let t of e)try{if(t.retries>=S){console.warn(`Service Worker: Max retries exceeded for ${t.id}, removing`),await l(t.id),r++;continue}let n=await fetch(t.url,{method:t.method,headers:t.headers,body:t.body?JSON.stringify(t.body):void 0});n.ok?(console.log(`Service Worker: Successfully synced ${t.id}`),await l(t.id),a++):n.status>=400&&n.status<500?(console.warn(`Service Worker: Client error for ${t.id}, removing`),await l(t.id),r++):(console.warn(`Service Worker: Server error for ${t.id}, will retry`),await g(t),r++)}catch(n){console.error(`Service Worker: Network error for ${t.id}`,n),await g(t),r++}console.log(`Service Worker: Sync complete. Success: ${a}, Failed: ${r}`),u({type:"SYNC_COMPLETE",data:{synced:a,failed:r,remaining:r}})}self.addEventListener("periodicsync",e=>{e.tag==="sync-data-periodic"&&(console.log("Service Worker: Periodic sync triggered"),e.waitUntil(h()))});self.addEventListener("online",()=>{console.log("Service Worker: Back online, triggering sync"),h()});})();
